# Integration-Test Module

The Integration-Test module provides end-to-end testing capabilities, and is available
to all lambda connectors developed using the Athena Federation SDK.

## How It Works

In order to test the connectors end-to-end, several infrastructure resources need to be
provisioned and deployed (e.g. DB instance, Lambda function, etc...) This module accomplishes
that by allowing AWS CloudFormation to manage the infrastructure resources. All an
integration-test writer needs to do is provide an implementation for a handful of functions,
and the Integration-Test module will do the rest.

This module provides the following benefits:
* Automatically provisions all infrastructure resources prior to testing, and de-provisions
them immediately after.
* Provides a set of public APIs that can be used to send queries via Athena using the lambda
connector.

## Writing Integration Tests

This section explains the steps necessary to create integration tests using the
Integration-Test module. For an actual code example, see the DynamoDB connector
[DynamoDbIntegTest integration-test class](https://github.com/awslabs/aws-athena-query-federation/blob/master/athena-dynamodb/src/test/java/com/amazonaws/athena/connectors/dynamodb/DynamoDbIntegTest.java).

### Dependencies

Add the Integration-Test module as a test dependency in the specific connector's `pom.xml` file (replace `2020.46.1`
with current version):

```xml
        <dependency>
            <groupId>com.amazonaws</groupId>
            <artifactId>athena-federation-integ-test</artifactId>
            <version>2020.46.1</version>
            <scope>test</scope>
        </dependency>
```

### Naming Convention

All integration-test classes need to adhere to the naming convention `<class>IntegTest`
(e.g. `public class DynamoDbIntegTest`). The same goes for the integration-tests themselves.

### Writing Integration Tests

Import the `@Test` annotation from `org.testng.annotations` and extend the Integration-Test
class (`IntegrationTestBase`):

```java
import org.testng.annotations.Test;

public class MyConnectorIntegTest extends IntegrationTestBase
{
    @Test
    public void exampleIntegTest()
    {
        //...
    }
}
```

Provide implementation for the following 4 abstract methods in the test class:

```java
    /**
     * Must be overridden in the extending class to setup the DB table (i.e. insert rows into table, etc...)
     */
    protected abstract void setUpTableData();

    /**
     * Must be overridden in the extending class (can be a no-op) to create a connector-specific CloudFormation stack
     * resource (e.g. DB table) using AWS CDK.
     * @param stack The current CloudFormation stack.
     */
    protected abstract void setUpStackData(final Stack stack);

    /**
     * Must be overridden in the extending class to set the lambda function's environment variables key-value pairs
     * (e.g. "spill_bucket":"myspillbucket"). See individual connector for expected environment variables. This method
     * can be a no-op in the extending class since some environment variables are set by default (spill_bucket,
     * spill_prefix, and disable_spill_encryption).
     */
    protected abstract void setConnectorEnvironmentVars(final Map<String, String> environmentVars);

    /**
     * Must be overridden in the extending class to get the lambda function's IAM access policy. The latter sets up
     * access to multiple connector-specific AWS services (e.g. DynamoDB, Elasticsearch etc...)
     * @return A policy document object.
     */
    protected abstract PolicyDocument getConnectorAccessPolicy();
```

### Integration-Test Public APIs

The Integration-Test module provides the following 5 public APIs that can be used to send DB
queries as part of the tests' execution:

```java
    /**
     * Gets the name of the lambda function generated by the Integration-Test module.
     * @return The name of the lambda function.
     */
    public String getLambdaFunctionName()

    /**
     * Uses the listDatabases Athena API to list databases for the data source utilizing the lambda function.
     * @return a list of database names.
     */
    public List<String> listDatabases()

    /**
     * Uses the startQueryExecution Athena API to process a "show tables" query utilizing the lambda function.
     * @param databaseName The name of the database.
     * @return A list of database table names.
     * @throws RuntimeException The Query is cancelled or has failed.
     */
    public List<String> listTables(String databaseName)

    /**
     * Uses the startQueryExecution Athena API to process a "describe table" query utilizing the lambda function.
     * @param databaseName The name of the database.
     * @param tableName The name of the database table.
     * @return A Map of the table column names and their associated types.
     * @throws RuntimeException The Query is cancelled or has failed.
     */
    public Map<String, String> describeTable(String databaseName, String tableName)

    /**
     * Sends a DB query via Athena and returns the query results.
     * @param query - The query string to be processed by Athena.
     * @return The query results object containing the metadata and row information.
     * @throws RuntimeException The Query is cancelled or has failed.
     */
    public GetQueryResultsResult startQueryExecution(String query)
```

## Running Integration Tests

This section explains the steps necessary to run the integration tests for a connector
locally from the terminal.

### Environment Setup

The following commands should be sent after cloning the Federation GitHub repository for
the first time, and each time the connector's code changes:

1. Build the SDK and connector (SDK only needs to build once): `mvn clean install`
2. Export the IAM credentials for the AWS account used for testing purposes.
3. Package the connector (from the connector's directory):
`sam package --template-file <connector.yaml> --output-template-file packaged.yaml
--s3-bucket <spill-bucket> --region <region> --force-upload`

### Running Integration Tests

The following command will trigger the integration tests: `mvn failsafe:integration-test`

If run from the root directory, the command will execute the integration tests for all connectors.
Likewise, if run from a specific connector's directory, it will trigger the integration tests
for the specific connector.
