# Integration-Test Suite

The integration-test suite provides end-to-end testing capabilities, and is available
to all connectors developed using the Athena Federation SDK.

## How It Works

In order to test the connectors end-to-end, several resources need to be provisioned
and deployed (e.g. DB instance, Lambda function, etc...) The Suite accomplishes that
by allowing AWS CloudFormation to manage the provisioning and de-provisioning of all
the necessary infrastructure resources in the specified AWS account. All an
integration-test writer needs to do is provide an implementation for a handful of
functions, and the Suite will do the rest.

## Writing Integration Tests

This section explains the steps necessary to create integration tests using the
Integration-Test Suite. For an actual code example, see the DynamoDB connector
[DynamoDBIT integration-test class](https://github.com/awslabs/aws-athena-query-federation/blob/master/athena-dynamodb/src/test/java/com/amazonaws/athena/connectors/dynamodb/DynamoDBIT.java).

### Dependencies

Include the following dependencies in the specific connector's `pom.xml` file:

```xml
        <dependency>
            <groupId>com.amazonaws</groupId>
            <artifactId>athena-federation-sdk-tools</artifactId>
            <version>1.0</version>
            <scope>test</scope>
        </dependency>
        <!-- https://mvnrepository.com/artifact/com.amazonaws/aws-java-sdk-cloudformation -->
        <dependency>
            <groupId>com.amazonaws</groupId>
            <artifactId>aws-java-sdk-cloudformation</artifactId>
            <version>${aws-sdk.version}</version>
            <scope>test</scope>
        </dependency>
        <!-- https://mvnrepository.com/artifact/software.amazon.awscdk/athena -->
        <dependency>
            <groupId>software.amazon.awscdk</groupId>
            <artifactId>athena</artifactId>
            <version>${aws-cdk.version}</version>
            <scope>test</scope>
        </dependency>
        <!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
            <version>${fasterxml.jackson.version}</version>
            <scope>runtime</scope>
        </dependency>
```

### Naming Convention

All integration-test classes need to adhere to the naming convention `<class>IT`
(e.g. `public class DynamoDBIT`). The same goes for the integration-tests themselves.

### Writing Integration Tests

Import the `@Test` annotation from `org.testng.annotations` and extend the Integration-Test
Suite (`IntegrationTestBase`):

```java
import org.testng.annotations.Test;

public class MyClassIT extends IntegrationTestBase
{
    @Test
    public void MyIT()
    {
        //...
    }
}
``` 

Provide implementation for the following methods in the test class:

```java
    /**
     * Must be overridden in the extending class to setup the DB table (i.e. insert rows into table, etc...)
     */
    protected abstract void setupData();

    /**
     * Must be overridden in the extending class (can be a no-op) to create a connector-specific CloudFormation stack
     * resource (e.g. DB table) using AWS CDK.
     * @param stack The current CloudFormation stack.
     */
    protected abstract void setupStackData(final Stack stack);

    /**
     * Must be overridden in the extending class to get the lambda function's environment variables key-value pairs
     * (e.g. "spill_bucket":"myspillbucket"). See individual connector for expected environment variables.
     * @return Map with parameter key-value pairs.
     */
    protected abstract Map<String, String> getConnectorEnvironmentVars();

    /**
     * Must be overridden in the extending class to get the lambda function's IAM access policy. The latter sets up
     * access to multiple connector-specific AWS services (e.g. DynamoDB, Elasticsearch etc...)
     * @return A policy document object.
     */
    protected abstract PolicyDocument getConnectorAccessPolicy();
```

### Public Suite APIs

The Integration-Test Suite provides the following 5 public APIs that can be used to send DB
queries as part of the tests' execution:

```java
    /**
     * Gets the name of the lambda function generated by the Integration-Test Suite.
     * @return The name of the lambda function.
     */
    public String getLambdaFunctionName()

    /**
     * Uses the listDatabases Athena API to list databases for the data source utilizing the lambda function.
     * @return a list of database names.
     */
    public List<String> listDatabases()

    /**
     * Uses the startQueryExecution Athena API to process a "show tables" query utilizing the lambda function.
     * @param databaseName The name of the database.
     * @return A list of database table names.
     * @throws InterruptedException Thread is interrupted during sleep.
     * @throws RuntimeException The Query is cancelled or has failed.
     */
    public List<String> listTables(String databaseName)

    /**
     * Uses the startQueryExecution Athena API to process a "describe table" query utilizing the lambda function.
     * @param databaseName The name of the database.
     * @param tableName The name of the database table.
     * @return A Map of the table column names and their associated types.
     * @throws InterruptedException Thread is interrupted during sleep.
     * @throws RuntimeException The Query is cancelled or has failed.
     */
    public Map<String, String> describeTable(String databaseName, String tableName)

    /**
     * Sends a DB query via Athena and returns the query results.
     * @param query - The query string to be processed by Athena.
     * @return The query results object containing the metadata and row information.
     * @throws InterruptedException Thread is interrupted during sleep.
     * @throws RuntimeException The Query is cancelled or has failed.
     */
    public GetQueryResultsResult startQueryExecution(String query)
```

## Running Integration Tests

This section explains the steps necessary to run the integration tests for a connector
locally from the terminal.

### Environment Setup

The following commands should be sent after cloning the Federation GitHub repository for
the first time, and each time the connector's code changes:

1. Build the SDK and connector (SDK only needs to build once): `mvn clean install`
2. Export the IAM credentials for the AWS account used for testing purposes.
3. Package the connector (from the connector's directory): 
`sam package --template-file <connector.yaml> --output-template-file packaged.yaml 
--s3-bucket <spill-bucket> --region <region> --force-upload`

### Running Integration Tests

The following command will trigger the integration tests: `mvn failsafe:integration-test`

If run from the root directory, the command will execute the integration tests for all connectors.
Likewise, if run from a specific connector's directory, it will trigger the integration tests
for the specific connector.
 