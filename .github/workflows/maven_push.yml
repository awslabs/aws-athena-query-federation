name: Java CI Push

on: [push, pull_request, workflow_dispatch]

jobs:
  # This is from: https://github.com/fkirc/skip-duplicate-actions#example-1-skip-entire-jobs
  pre_job:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5.3.1
        with:
          cancel_others: 'true'
          concurrent_skipping: 'same_content_newer'
          do_not_skip: '["workflow_dispatch", "schedule", "merge_group", "pull_request"]'

  build:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    runs-on: aws-athena-query-federation_ubuntu-latest_16-core
    strategy:
      matrix:
        java-version: ['11', '17']
    steps:
      - uses: actions/checkout@v5
      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ matrix.java-version }}
      - name: Build with Maven
        env:
          AWS_DEFAULT_REGION: us-east-1
          AWS_REGION: us-east-1
        run: mvn -B clean package -T 1C --file pom.xml -Dorg.slf4j.simpleLogger.defaultLogLevel=WARN --no-transfer-progress
      # Identify if any files were modified as a result of running maven build.
      - name: Identify any Maven Build changes
        run: >
          ! (git status | grep "modified: " )

      # -------- Codecov coverage upload --------
      # Fork PRs: upload WITHOUT token
      - name: Upload coverage reports to Codecov (fork PRs, no token)
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork && matrix.java-version == '17' }}
        uses: codecov/codecov-action@v5

      # Pushes & same-repo PRs: upload WITH token
      - name: Upload coverage reports to Codecov (internal only)
        if: ${{ (github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork)) && matrix.java-version == '17' }}
        uses: codecov/codecov-action@v5
        with:
          slug: awslabs/aws-athena-query-federation
          token: ${{ secrets.CODECOV_TOKEN }}
      # -------- Codecov test results --------
      # Fork PRs: no token
      - name: Upload test results to Codecov (fork PRs, no token)
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork && matrix.java-version == '17' }}
        uses: codecov/test-results-action@v1
        with:
          slug: awslabs/aws-athena-query-federation

      # Pushes & same-repo PRs: with token
      - name: Upload test results to Codecov (internal only)
        if: ${{ !cancelled() && (github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork)) && matrix.java-version == '17' }}
        uses: codecov/test-results-action@v1
        with:
          slug: awslabs/aws-athena-query-federation
          token: ${{ secrets.CODECOV_TOKEN }}
